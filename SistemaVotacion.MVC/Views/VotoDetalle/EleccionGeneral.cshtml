@{
    ViewData["Title"] = "Resultados Elección General";
}

@if (ViewBag.IdProceso == null)
{
    <div class="alert alert-warning">No se ha especificado un proceso electoral.</div>
    return;
}

    <link rel="stylesheet" href="~/css/VotoDetalle.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-4 mb-5">
    <!-- Header Area -->
    <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white shadow-sm rounded">
        <h2 class="mb-0 text-primary fw-bold"><i class="bi bi-bar-chart-fill me-2"></i>Resultados Generales</h2>
        
        <form method="get" class="d-flex align-items-center">
            <input type="hidden" name="idProceso" value="@ViewBag.IdProceso" />
            <select name="idProvincia" class="form-select me-2 border-primary" onchange="this.form.submit()" style="max-width: 250px;">
                <option value="">-- Nación --</option>
                @if (ViewBag.Provincias != null)
                {
                    foreach (var prov in ViewBag.Provincias as List<SistemaVotacion.Modelos.Provincia>)
                    {
                        <!option value="@prov.Id" @(ViewBag.IdProvincia == prov.Id ? "selected" : "")>@prov.NombreProvincia</!option>
                    }
                }
            </select>
        </form>

        <div>

            <a href="@Url.Action("ExportarPDF", "VotoDetalle", new { idProceso = ViewBag.IdProceso, tipo = "general", idProvincia = ViewBag.IdProvincia })" class="btn btn-outline-danger">
                <i class="bi bi-file-pdf me-2"></i>PDF
            </a>
        </div>
    </div>

    <!-- Debug Section Removed (As requested) -->
    <!-- Required for JS Charts -->
    <div id="rawJsonPreview" style="display:none;">@ViewBag.Resultado</div>

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger shadow-sm">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @ViewBag.Error
        </div>
    }

    <!-- Main Content -->
    <div class="row g-4">
        <!-- Chart Column -->
        <div class="col-lg-5">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                    <h5 class="card-title fw-bold text-dark">Distribución de Votos</h5>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center position-relative p-4">
                    <div style="width: 100%; min-height: 300px; text-align: center;">
                        <!-- Server Side Chart (ScottPlot) -->
                        <img src="@Url.Action("GetChartImage", "VotoDetalle", new { idProceso = ViewBag.IdProceso, idProvincia = ViewBag.IdProvincia })" 
                             alt="Gráfica de Resultados" 
                             class="img-fluid" 
                             style="max-height: 300px;" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                        <div style="display:none;" class="alert alert-warning mt-2">No se pudo cargar la gráfica.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Column -->
        <div class="col-lg-7">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0 fw-bold">Detalle por Organización Política</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4 py-3">Organización / Lista</th>
                                    <th class="py-3 text-center">Lista #</th>
                                    <th class="py-3 text-end">Votos</th>
                                    <th class="pe-4 py-3 text-end">Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody id="tablaResultados">
                                <!-- JS Injected -->
                            </tbody>
                            <tfoot class="bg-light fw-bold border-top-2">
                                <tr>
                                    <td colspan="2" class="ps-4 py-3 text-uppercase">Total Votes</td>
                                    <td class="text-end py-3" id="totalVotos">0</td>
                                    <td class="pe-4 py-3 text-end">100%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* =======================
       DATOS API
       ======================= */
    let data = [];
    const rawData = document.getElementById("rawJsonPreview").innerText;
    
    try {
        if(rawData && rawData !== "[]") {
            data = JSON.parse(rawData);
        }
    } catch (e) {
        console.error("Error parsing JSON", e);
        data = [];
    }

    console.log("Parsed Data:", data);

    // Helper for agnostic property access (Pascal or Camel)
    const getProp = (obj, prop) => {
        if (!obj) return undefined;
        // Check exact match first
        if (obj[prop] !== undefined) return obj[prop];
        // Check camelCase
        const camel = prop.charAt(0).toLowerCase() + prop.slice(1);
        if (obj[camel] !== undefined) return obj[camel];
        return undefined;
    };

    const votes = data.map(item => getProp(item, 'Votos') || 0);
    const labels = data.map(item => getProp(item, 'Lista') || "N/A");
    const total = votes.reduce((a, b) => a + b, 0);

    // Render Tabla
    const tbody = document.getElementById("tablaResultados");
    let htmlTabla = "";
    
    // Sort logic handled in API usually, but safety check
    data.forEach(item => {
        const votos = getProp(item, 'Votos') || 0;
        const lista = getProp(item, 'Lista') || "Sin Nombre";
        const numero = getProp(item, 'Numero') || 0;
        const urlLogoOrig = getProp(item, 'UrlLogo');
        const esValido = getProp(item, 'EsValido');

        const porc = total > 0 ? ((votos / total) * 100).toFixed(2) : 0;
        
        let logoHtml = "";
        if (esValido) {
             let urlLogo = urlLogoOrig || "img/default-lista.png";
             if (urlLogo && !urlLogo.startsWith("http")) {
                 urlLogo = '@Url.Content("~/")' + urlLogo;
             }
             logoHtml = `<img src="${urlLogo}" alt="Logo" class="rounded-circle border" style="width: 40px; height: 40px; object-fit: contain; margin-right: 12px; background: #fff;">`;
        } else {
             logoHtml = `<div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-secondary text-white me-3" style="width: 40px; height: 40px;"><i class="bi bi-archive"></i></div>`;
        }

        const bgClass = !esValido ? "bg-warning-subtle" : "";

        htmlTabla += `
            <tr class="${bgClass}">
                <td class="ps-4">
                    <div class="d-flex align-items-center">
                        ${logoHtml}
                        <span class="fw-medium text-dark">${lista}</span>
                    </div>
                </td>
                <td class="text-center">${esValido ? '<span class="badge bg-primary rounded-pill px-3">' + numero + '</span>' : '-'}</td>
                <td class="text-end fw-bold text-dark">${votos}</td>
                <td class="pe-4 text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <span class="me-2">${porc}%</span>
                        <div class="progress" style="width: 50px; height: 4px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: ${porc}%" aria-valuenow="${porc}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </td>
            </tr>`;
    });

    if(data.length === 0) {
        htmlTabla = `<tr><td colspan="4" class="text-center py-5 text-muted"><i class="bi bi-inbox fs-1 d-block mb-3"></i>No hay resultados registrados aún.</td></tr>`;
    }

    tbody.innerHTML = htmlTabla;
    document.getElementById("totalVotos").innerText = total;

    tbody.innerHTML = htmlTabla;
    document.getElementById("totalVotos").innerText = total;

    // Chart logic removed (Replaced by Server-Side Image)
</script>
