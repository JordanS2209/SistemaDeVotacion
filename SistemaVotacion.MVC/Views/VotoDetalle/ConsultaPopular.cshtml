@{
    ViewData["Title"] = "Resultados Consulta Popular";
}
@{
    if (ViewBag.IdPadron == null || ViewBag.IdProceso == null)
    {
        <h3>Error: no se pudo cargar la boleta</h3>
        return;
    }

    int idPadron = (int)ViewBag.IdPadron;
    int idProceso = (int)ViewBag.IdProceso;
}


<link rel="stylesheet" href="~/css/ResultadosConsultaPopular.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="titulo-principal mb-0">Resultados Consulta Popular</h2>

    <a href="@Url.Action("ExportarPDF", "VotoDetalle", new { idProceso = ViewBag.IdProceso, tipo = "consulta" })" class="btn btn-danger">
        <i class="bi bi-file-pdf me-2"></i>Exportar PDF
    </a>
</div>

<!-- =======================
     RESUMEN GENERAL
     ======================= -->
<div class="contenedor-principal">

    <div class="card-grafica">
        <h3 class="titulo-grafica">Resumen General</h3>
        <canvas id="graficaResumen"></canvas>
    </div>

</div>

<!-- =======================
     RESULTADOS POR PREGUNTA
     ======================= -->
<div class="contenedor-preguntas" id="contenedorPreguntas"></div>

<script>
    /* =======================
       DATOS API
       ======================= */
    let data = [];
    try {
        data = JSON.parse('@Html.Raw(ViewBag.Resultado ?? "[]")');
    } catch (e) {
        console.error("Error parsing JSON", e);
        data = [];
    }
    
    const contenedor = document.getElementById("contenedorPreguntas");
    contenedor.innerHTML = "";

    if (data.length === 0) {
        contenedor.innerHTML = "<p>No hay resultados disponibles.</p>";
    }

    data.forEach((item, index) => {
        const idCanvas = `grafica_${index}`;
        
        // Crear Card
        const card = document.createElement("div");
        card.className = "pregunta-card";
        
        let htmlResultados = `<h4 class="texto-pregunta">${item.Pregunta}</h4><div class="datos">`;
        
        const labels = [];
        const values = [];
        const backgroundColors = [];
        const palette = ['#2e7d32', '#c62828', '#1976d2', '#ff9800', '#9c27b0'];

        item.Resultados.forEach((r, i) => {
             htmlResultados += `<span class="badge bg-secondary me-2">${r.Opcion}: ${r.Votos}</span>`;
             labels.push(r.Opcion);
             values.push(r.Votos);
             backgroundColors.push(palette[i % palette.length]);
        });
        
        htmlResultados += `</div><canvas id="${idCanvas}" height="100"></canvas>`;
        card.innerHTML = htmlResultados;
        contenedor.appendChild(card);

        // Renderizar Chart
        new Chart(document.getElementById(idCanvas), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Votos',
                    data: values,
                    backgroundColor: backgroundColors
                }]
            },
            options: {
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } }
            }
        });
    });

    // Ocultar resumen general si no hay datos consolidados
    document.querySelector('.card-grafica').style.display = 'none'; // ocultamos el resumen hardcoded anterior
    
</script>
